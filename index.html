<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>2026 Campaign Calendar</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;800&family=DM+Mono:wght@400;500&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --cream:    #f0ebe0;
    --cream2:   #e8e2d5;
    --ink:      #1a1a18;
    --ink2:     #3a3830;
    --muted:    #9a9280;
    --border:   #cdc8bb;
    --nav-bg:   #1e1e1a;
    --nav-text: #e8e4dc;

    --c-planning:  #5a8a5a;
    --c-execution: #4a7aaf;
    --c-launch:    #bf5030;
    --c-review:    #8a6030;
    --c-done:      #8a9a88;

    --label-w: 220px;
    --row-padding: 80px;   /* vertical space for label + date above/below line */
    --font-serif: 'Playfair Display', serif;
    --font-mono:  'DM Mono', monospace;
    --font-ui:    'Inter', sans-serif;
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--cream);
    color: var(--ink);
    font-family: var(--font-ui);
    min-height: 100vh;
  }

  /* ── MODAL ──────────────────────────────── */
  #modal-overlay {
    position: fixed; inset: 0; z-index: 999;
    background: rgba(26,26,24,.82);
    backdrop-filter: blur(6px);
    display: flex; align-items: center; justify-content: center;
  }
  #modal-overlay.hidden { display: none; }
  .modal-box {
    background: var(--cream); border: 1px solid var(--border);
    border-radius: 4px; padding: 48px; width: min(460px, 92vw);
    box-shadow: 0 32px 80px rgba(0,0,0,.35);
  }
  .modal-eye  { font-family: var(--font-mono); font-size: 10px; letter-spacing: .14em; color: var(--muted); text-transform: uppercase; margin-bottom: 12px; }
  .modal-head { font-family: var(--font-serif); font-size: 26px; line-height: 1.2; margin-bottom: 10px; }
  .modal-sub  { font-size: 13px; color: var(--muted); line-height: 1.6; margin-bottom: 26px; }
  .modal-inp  { width: 100%; background: #fff; border: 1px solid var(--border); border-radius: 3px; padding: 12px 14px; color: var(--ink); font-family: var(--font-mono); font-size: 13px; outline: none; transition: border-color .2s; margin-bottom: 12px; }
  .modal-inp:focus { border-color: var(--ink); }
  .modal-inp::placeholder { color: var(--muted); }
  .modal-btn  { width: 100%; background: var(--ink); color: var(--cream); border: none; border-radius: 3px; padding: 13px; font-family: var(--font-ui); font-weight: 600; font-size: 13px; letter-spacing: .04em; cursor: pointer; transition: opacity .15s; }
  .modal-btn:hover { opacity: .82; }
  .modal-btn:disabled { opacity: .4; cursor: default; }
  .modal-err  { font-size: 12px; color: var(--c-launch); margin-top: 10px; min-height: 16px; font-family: var(--font-mono); }

  /* ── NAV ────────────────────────────────── */
  nav {
    background: var(--nav-bg); color: var(--nav-text);
    display: flex; align-items: center; padding: 0 32px;
    height: 42px; gap: 0; flex-wrap: nowrap; overflow: hidden;
  }
  .nav-section { display: flex; align-items: center; gap: 14px; }
  .nav-lbl { font-family: var(--font-mono); font-size: 10px; letter-spacing: .12em; text-transform: uppercase; color: rgba(232,228,220,.4); margin-right: 4px; }
  .nav-item { display: flex; align-items: center; gap: 5px; font-family: var(--font-mono); font-size: 11px; color: rgba(232,228,220,.8); white-space: nowrap; }
  .ndot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }
  .nav-spacer { flex: 1; }
  .nav-live { font-family: var(--font-mono); font-size: 10px; color: rgba(232,228,220,.45); display: flex; align-items: center; gap: 6px; }
  .live-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--c-planning); }
  @keyframes blink { 0%,100%{opacity:1} 50%{opacity:.2} }

  /* ── PAGE HEAD ──────────────────────────── */
  .page-head {
    padding: 32px 32px 16px;
    border-bottom: 2px solid var(--ink);
    display: flex; align-items: baseline; gap: 20px; flex-wrap: wrap;
  }
  .page-head h1 { font-family: var(--font-serif); font-size: 36px; font-weight: 800; color: var(--ink); line-height: 1; }
  .page-meta { font-family: var(--font-mono); font-size: 11px; color: var(--muted); letter-spacing: .08em; text-transform: uppercase; }
  .page-actions { margin-left: auto; display: flex; align-items: center; gap: 10px; }
  #refresh-btn {
    display: flex; align-items: center; gap: 6px; background: transparent;
    border: 1px solid var(--border); border-radius: 2px; color: var(--muted);
    font-family: var(--font-mono); font-size: 11px; padding: 5px 12px;
    cursor: pointer; transition: all .15s; white-space: nowrap;
  }
  #refresh-btn:hover { border-color: var(--ink); color: var(--ink); }
  #sdot { width: 6px; height: 6px; border-radius: 50%; background: var(--muted); transition: background .3s; flex-shrink: 0; }
  #sdot.live    { background: var(--c-planning); }
  #sdot.loading { background: var(--c-review); animation: blink 1s infinite; }
  #sdot.error   { background: var(--c-launch); }

  /* ── MAIN ───────────────────────────────── */
  main { opacity: 0; transition: opacity .35s; }
  main.visible { opacity: 1; }
  #msg { padding: 80px 32px; text-align: center; font-family: var(--font-mono); font-size: 13px; color: var(--muted); }

  .scroll-wrap { overflow-x: auto; overflow-y: visible; }
  .tl-root { min-width: 900px; }

  /* ── MONTH HEADER ───────────────────────── */
  .month-header {
    position: sticky; top: 0; z-index: 10;
    background: var(--cream2);
    border-bottom: 1px solid var(--border);
    display: flex; height: 32px;
  }
  .mh-spacer { flex-shrink: 0; width: var(--label-w); border-right: 1px solid var(--border); }
  .mh-track  { flex: 1; position: relative; overflow: hidden; }
  .mh-cell {
    position: absolute; top: 0; bottom: 0;
    display: flex; align-items: center; padding-left: 8px;
    font-family: var(--font-mono); font-size: 10px; color: var(--muted);
    letter-spacing: .09em; text-transform: uppercase;
    border-left: 1px solid var(--border); white-space: nowrap;
  }

  /* ── CAMPAIGN ROW ───────────────────────── */
  .camp-group {
    border-bottom: 1px solid var(--border);
    background: var(--cream);
  }
  .camp-row { display: flex; align-items: stretch; }

  /* Left label */
  .camp-lbl {
    flex-shrink: 0; width: var(--label-w);
    padding: 0 20px;
    border-right: 1px solid var(--border);
    display: flex; flex-direction: column; justify-content: center;
    gap: 5px; min-height: 140px;
  }
  .camp-name { font-family: var(--font-serif); font-size: 15px; font-weight: 700; color: var(--ink); line-height: 1.25; }
  .camp-launch { font-family: var(--font-mono); font-size: 10px; color: var(--muted); letter-spacing: .04em; margin-top: 2px; }

  /* Timeline canvas */
  .camp-tl {
    flex: 1;
    position: relative;
    min-height: 140px;  /* enough room for label above + date below the line */
  }

  /* Month grid lines */
  .grid-line  { position: absolute; top: 0; bottom: 0; width: 1px; background: var(--border); pointer-events: none; }
  .today-line { position: absolute; top: 0; bottom: 0; width: 1px; background: var(--ink); opacity: .25; pointer-events: none; z-index: 1; }
  .today-lbl  {
    position: absolute; top: 4px; transform: translateX(-50%);
    font-family: var(--font-mono); font-size: 8px; color: var(--ink); opacity: .4;
    letter-spacing: .07em; white-space: nowrap; pointer-events: none; z-index: 1;
    text-transform: uppercase;
  }

  /* Horizontal timeline arrow */
  .tl-line {
    position: absolute;
    top: 50%; transform: translateY(-50%);
    left: 0; right: 28px;
    height: 1.5px; background: var(--ink2); opacity: .3;
    pointer-events: none;
  }
  /* Arrow head */
  .tl-arrow {
    position: absolute;
    top: 50%; transform: translateY(-50%);
    right: 0;
    width: 0; height: 0;
    border-top: 7px solid transparent;
    border-bottom: 7px solid transparent;
    border-left: 14px solid var(--ink2);
    opacity: .3;
    pointer-events: none;
  }

  /* ── MILESTONE MARKER ───────────────────── */
  /*
    Each milestone is a vertical tick at its date position.
    Label rendered above or below alternating to avoid overlap.
    Structure:
      .ms-marker (positioned absolutely)
        .ms-label-above or .ms-label-below
        .ms-tick
        .ms-date-above or .ms-date-below
  */
  .ms-marker {
    position: absolute;
    top: 0; bottom: 0;
    display: flex; flex-direction: column; align-items: center;
    cursor: pointer;
    transform: translateX(-50%);
    z-index: 5;
  }
  .ms-marker:hover .ms-tick { background: var(--ink); opacity: 1; }
  .ms-marker:hover .ms-box  { border-color: var(--ink); color: var(--ink); }

  /* Box label (like screenshot 2) */
  .ms-box {
    background: var(--cream);
    border: 1px solid var(--ink2);
    border-radius: 2px;
    padding: 4px 7px;
    font-family: var(--font-ui); font-size: 10px; font-weight: 500;
    color: var(--ink2);
    text-align: center;
    line-height: 1.3;
    max-width: 110px;
    white-space: normal;
    word-break: break-word;
    transition: border-color .12s, color .12s;
    pointer-events: none;
  }
  .ms-box.done { opacity: .45; background: var(--cream2); }

  /* Tick line connecting box to the horizontal line */
  .ms-tick {
    width: 1px; background: var(--ink2); opacity: .5;
    flex: 1;
    pointer-events: none;
    transition: opacity .12s;
  }

  /* Date label */
  .ms-date {
    font-family: var(--font-mono); font-size: 10px; font-weight: 500;
    color: var(--ink); letter-spacing: .02em;
    white-space: nowrap;
    padding: 2px 0;
    pointer-events: none;
  }
  .ms-date.done { opacity: .45; }

  /* Diamond on the line */
  .ms-diamond {
    width: 8px; height: 8px;
    background: var(--ink);
    transform: rotate(45deg);
    flex-shrink: 0;
    pointer-events: none;
    transition: transform .12s;
  }
  .ms-diamond.done { background: var(--muted); }
  .ms-marker:hover .ms-diamond { transform: rotate(45deg) scale(1.4); }

  /* Tooltip */
  .tt {
    position: fixed; z-index: 500; pointer-events: none;
    opacity: 0; transition: opacity .1s;
    background: var(--ink); color: var(--cream);
    border-radius: 3px; padding: 10px 14px; max-width: 240px;
    box-shadow: 0 10px 30px rgba(0,0,0,.3);
  }
  .tt.on { opacity: 1; }
  .tt-name  { font-size: 13px; font-weight: 600; line-height: 1.3; margin-bottom: 5px; }
  .tt-date  { font-family: var(--font-mono); font-size: 11px; opacity: .65; margin-bottom: 3px; }
  .tt-phase { font-family: var(--font-mono); font-size: 10px; opacity: .45; }

  @media (max-width: 700px) {
    :root { --label-w: 120px; }
    .camp-name { font-size: 12px; }
  }
</style>
</head>
<body>

<!-- MODAL -->
<div id="modal-overlay">
  <div class="modal-box">
    <div class="modal-eye">2026 · Campaign Calendar</div>
    <h2 class="modal-head">Connect to Airtable</h2>
    <p class="modal-sub">Enter your personal access token. Stored in this browser session only.</p>
    <input class="modal-inp" id="token-input" type="password" placeholder="pat2Cx…" autocomplete="off" spellcheck="false">
    <button class="modal-btn" id="connect-btn">Connect →</button>
    <div class="modal-err" id="modal-err"></div>
  </div>
</div>

<!-- TOOLTIP -->
<div class="tt" id="tt">
  <div class="tt-name"  id="tt-name"></div>
  <div class="tt-date"  id="tt-date"></div>
  <div class="tt-phase" id="tt-phase"></div>
</div>

<!-- NAV -->
<nav>
  <div class="nav-lbl">Status</div>
  <div class="nav-section">
    <span class="nav-item"><span class="ndot" style="background:#6b8c6b"></span>Done</span>
    <span class="nav-item"><span class="ndot" style="background:var(--muted)"></span>To Do</span>
  </div>
  <div class="nav-spacer"></div>
  <div class="nav-live">
    <span class="live-dot" id="ldot"></span>
    <span id="nav-status">connecting</span>
  </div>
</nav>

<!-- PAGE HEAD -->
<div class="page-head">
  <h1>Active Campaigns</h1>
  <span class="page-meta" id="page-meta">loading…</span>
  <div class="page-actions">
    <button id="refresh-btn"><span id="sdot"></span> Refresh</button>
  </div>
</div>

<!-- MAIN -->
<main id="main">
  <div id="msg">Connecting to Airtable…</div>
  <div class="scroll-wrap" id="scroll-wrap" style="display:none">
    <div class="tl-root" id="tl-root"></div>
  </div>
</main>

<script>
// ── CONFIG ────────────────────────────────────────────
const BASE_ID        = 'appeiBEuOf8zRHX96';
const MILESTONES_TBL = '[MASTER] Milestones';
const CAMPAIGNS_TBL  = 'Campaigns';

// The 7 key milestones to display (flexible partial match)
const KEY_MILESTONES = [
  'Campaign Kick-Off',
  'Campaign Kick-off',
  'First Half Campaign Plan Approved',
  'Second Half Campaign Plan Approved',
  'Finalized Campaign Plan Deck',
  'Finalized Campaign Deck',
  'Briefing Request in Notion',
  'Briefing Request',
  'Finalized Creative Asset Delivered',
  'Retailer In-Store Launch',
  'Retailer Launch Campaign',
  'Retailer Launch',
];

// Short display names to keep boxes compact
const SHORT_NAMES = {
  'Campaign Kick-Off':                   'Campaign\nKick-Off',
  'Campaign Kick-off':                   'Campaign\nKick-Off',
  'First Half Campaign Plan Approved':   '1st Half Plan\nApproved',
  'Second Half Campaign Plan Approved':  '2nd Half Plan\nApproved',
  'Finalized Campaign Plan Deck':        'Finalized\nCampaign Deck',
  'Finalized Campaign Deck':             'Finalized\nCampaign Deck',
  'Briefing Request in Notion':          'Briefing\nRequest',
  'Briefing Request':                    'Briefing\nRequest',
  'Finalized Creative Asset Delivered':  'Finalized\nCreative Asset',
  'Retailer In-Store Launch':            'Retailer\nIn-Store Launch',
  'Retailer Launch Campaign':            'Retailer Launch',
  'Retailer Launch':                     'Retailer Launch',
};

function shortName(name) {
  if (!name) return '';
  for (const [k, v] of Object.entries(SHORT_NAMES)) {
    if (name.toLowerCase().includes(k.toLowerCase())) return v;
  }
  return name.length > 22 ? name.slice(0, 20) + '…' : name;
}

let TOKEN = '', allMilestones = [], campaignMap = {};

// ── MODAL ─────────────────────────────────────────────
const overlay    = document.getElementById('modal-overlay');
const tokenInput = document.getElementById('token-input');
const connectBtn = document.getElementById('connect-btn');
const modalErr   = document.getElementById('modal-err');

const saved = sessionStorage.getItem('at_tok_2026');
if (saved) { TOKEN = saved; overlay.classList.add('hidden'); init(); }

connectBtn.addEventListener('click', async () => {
  const t = tokenInput.value.trim();
  if (!t) { modalErr.textContent = 'Please paste your Airtable personal access token.'; return; }
  connectBtn.disabled = true;
  connectBtn.textContent = 'Connecting…';
  modalErr.textContent = '';
  const ok = await testToken(t);
  if (ok) {
    TOKEN = t;
    sessionStorage.setItem('at_tok_2026', t);
    overlay.classList.add('hidden');
    init();
  } else {
    modalErr.textContent = 'Connection failed — check your token and try again.';
    connectBtn.disabled = false;
    connectBtn.textContent = 'Connect →';
  }
});
tokenInput.addEventListener('keydown', e => { if (e.key === 'Enter') connectBtn.click(); });

async function testToken(t) {
  try {
    const r = await fetch(`https://api.airtable.com/v0/${BASE_ID}/${enc(MILESTONES_TBL)}?maxRecords=1`,
      { headers: { Authorization: `Bearer ${t}` } });
    return r.ok;
  } catch { return false; }
}

// ── FETCH ─────────────────────────────────────────────
async function fetchTable(tbl) {
  const recs = [];
  let offset = null;
  do {
    let url = `https://api.airtable.com/v0/${BASE_ID}/${enc(tbl)}?pageSize=100`;
    if (offset) url += `&offset=${offset}`;
    const r = await fetch(url, { headers: { Authorization: `Bearer ${TOKEN}` } });
    if (!r.ok) throw new Error(`Airtable ${r.status} on "${tbl}"`);
    const d = await r.json();
    recs.push(...d.records);
    offset = d.offset || null;
  } while (offset);
  return recs;
}

function setStatus(s) {
  const sdot = document.getElementById('sdot');
  const ldot = document.getElementById('ldot');
  sdot.className = s;
  ldot.style.background = s === 'live' ? 'var(--c-planning)' : s === 'error' ? 'var(--c-launch)' : 'var(--muted)';
  ldot.style.animation = s === 'loading' ? 'blink 1s infinite' : '';
  document.getElementById('nav-status').textContent =
    s === 'live' ? 'Live · Airtable' : s === 'loading' ? 'Loading…' : s === 'error' ? 'Error' : '…';
}

const enc = s => encodeURIComponent(s);

// ── INIT ──────────────────────────────────────────────
async function init() {
  setStatus('loading');
  setMsg('Fetching campaigns…');

  try {
    // Build Campaign ID → name map
    campaignMap = {};
    try {
      const campRecs = await fetchTable(CAMPAIGNS_TBL);
      campRecs.forEach(rec => {
        const f = rec.fields;
        const name = f['Name'] || f['Campaign Name'] || f['Campaign'] || f['Title'] || Object.values(f)[0] || rec.id;
        campaignMap[rec.id] = String(name);
      });
    } catch(e) {
      console.warn('Could not load Campaigns table:', e.message);
    }

    setMsg('Fetching milestones…');
    const rawRecs = await fetchTable(MILESTONES_TBL);
    console.log('Sample milestone fields:', rawRecs[0]?.fields);

    // Normalise + filter
    allMilestones = rawRecs
      .map(rec => {
        const f = rec.fields;
        let campName = 'Uncategorized';
        const cf = f['Campaign'];
        if (Array.isArray(cf) && cf.length > 0) campName = campaignMap[cf[0]] || cf[0];
        else if (typeof cf === 'string' && cf)   campName = campaignMap[cf]    || cf;

        return {
          id:        rec.id,
          name:      f['Milestones'] || f['Name'] || '',
          campaign:  campName,
          phase:     f['Phase']   || 'Other',
          status:    f['Status']  || 'To Do',
          startDate: bestDate(f['Auto Start Date'], f['Start Date']),
          endDate:   bestDate(f['Auto End Date'],   f['Start Date']),
          sortOrder: f['Sort Order'] || 999,
        };
      })
      .filter(m => isKey(m.name) && m.startDate);

    console.log('Key milestones loaded:', allMilestones.length);

    setStatus('live');
    const camps = new Set(allMilestones.map(m => m.campaign));
    document.getElementById('page-meta').textContent =
      `${camps.size} Campaign${camps.size !== 1 ? 's' : ''} · Q1–Q3 2026`;

    render();
    document.getElementById('main').classList.add('visible');

  } catch(e) {
    setStatus('error');
    setMsg('⚠ ' + e.message);
    console.error(e);
  }
}

function isKey(name) {
  if (!name) return false;
  const n = name.toLowerCase();
  return KEY_MILESTONES.some(k => n.includes(k.toLowerCase()));
}

document.getElementById('refresh-btn').addEventListener('click', () => { if (TOKEN) init(); });

// ── RENDER ────────────────────────────────────────────
function render() {
  const data = allMilestones;
  const bycamp = groupBy(data, 'campaign');
  const campNames = Object.keys(bycamp).sort();

  if (!campNames.length) { setMsg('No milestone data found.'); return; }
  document.getElementById('msg').style.display = 'none';
  document.getElementById('scroll-wrap').style.display = '';

  // Global date range
  let minTs = Infinity, maxTs = -Infinity;
  data.forEach(m => {
    if (m.startDate) { if (m.startDate < minTs) minTs = m.startDate; if (m.startDate > maxTs) maxTs = m.startDate; }
    if (m.endDate && m.endDate > maxTs) maxTs = m.endDate;
  });

  // Snap to months + padding on each side
  const minD = new Date(minTs); minD.setDate(1);
  const maxD = new Date(maxTs); maxD.setDate(1); maxD.setMonth(maxD.getMonth() + 2);
  const rMin = minD.getTime(), rMax = maxD.getTime(), span = rMax - rMin;
  const pct = ts => ((ts - rMin) / span * 100).toFixed(4) + '%';

  // Months
  const months = [];
  const mc = new Date(rMin);
  while (mc.getTime() < rMax) { months.push(new Date(mc)); mc.setMonth(mc.getMonth() + 1); }

  const root = document.getElementById('tl-root');
  root.innerHTML = '';

  // ── Month header ──
  const mhdr = mk('div', 'month-header');
  mhdr.appendChild(mk('div', 'mh-spacer'));
  const mtrack = mk('div', 'mh-track');
  months.forEach(m => {
    const c = mk('div', 'mh-cell');
    c.style.left = pct(m.getTime());
    c.textContent = m.toLocaleString('default', { month: 'short' }).toUpperCase();
    mtrack.appendChild(c);
  });
  mhdr.appendChild(mtrack);
  root.appendChild(mhdr);

  const today = Date.now();

  // ── Campaign rows ──
  campNames.forEach(campName => {
    const cms = bycamp[campName].sort((a, b) => a.startDate - b.startDate);

    // Find latest milestone for launch display
    const launchMs = cms.filter(m => isLaunch(m.name));
    const launchDate = launchMs.length
      ? Math.max(...launchMs.map(m => m.startDate))
      : Math.max(...cms.map(m => m.startDate));

    const group = mk('div', 'camp-group');
    const row   = mk('div', 'camp-row');

    // ── Left label ──
    const lbl = mk('div', 'camp-lbl');
    const nm = mk('div', 'camp-name'); nm.textContent = campName; lbl.appendChild(nm);
    const ld = mk('div', 'camp-launch');
    ld.textContent = 'Launch ' + fmtDateShort(launchDate);
    lbl.appendChild(ld);
    row.appendChild(lbl);

    // ── Timeline canvas ──
    const tl = mk('div', 'camp-tl');

    // Grid lines
    months.forEach(m => {
      const gl = mk('div', 'grid-line'); gl.style.left = pct(m.getTime()); tl.appendChild(gl);
    });

    // Today line
    if (today >= rMin && today <= rMax) {
      const tll = mk('div', 'today-line'); tll.style.left = pct(today); tl.appendChild(tll);
      const tlb = mk('div', 'today-lbl'); tlb.style.left = pct(today); tlb.textContent = 'TODAY'; tl.appendChild(tlb);
    }

    // Horizontal arrow line
    tl.appendChild(mk('div', 'tl-line'));
    tl.appendChild(mk('div', 'tl-arrow'));

    // ── Milestone markers ──
    // Alternate above/below to reduce label collisions
    cms.forEach((m, i) => {
      const above = i % 2 === 0; // even = label above line, odd = label below

      const marker = mk('div', 'ms-marker');
      marker.style.left = pct(m.startDate);
      marker.style.top  = '0';

      const isDone = m.status === 'Done';
      const sn = shortName(m.name);

      if (above) {
        // Box label on top half
        const box = mk('div', 'ms-box' + (isDone ? ' done' : ''));
        box.style.marginTop = '8px';
        box.textContent = sn;
        marker.appendChild(box);

        // Tick from box down to line (top half)
        const tick = mk('div', 'ms-tick');
        marker.appendChild(tick);

        // Diamond on the line
        const dia = mk('div', 'ms-diamond' + (isDone ? ' done' : ''));
        marker.appendChild(dia);

        // Empty spacer for bottom half + date
        const spacer = mk('div', 'ms-tick');
        spacer.style.background = 'transparent';
        marker.appendChild(spacer);

        const date = mk('div', 'ms-date' + (isDone ? ' done' : ''));
        date.textContent = fmtDateShort(m.startDate);
        date.style.marginBottom = '8px';
        marker.appendChild(date);

      } else {
        // Date on top half
        const date = mk('div', 'ms-date' + (isDone ? ' done' : ''));
        date.textContent = fmtDateShort(m.startDate);
        date.style.marginTop = '8px';
        marker.appendChild(date);

        // Tick from date down to line (top half)
        const tick = mk('div', 'ms-tick');
        marker.appendChild(tick);

        // Diamond on the line
        const dia = mk('div', 'ms-diamond' + (isDone ? ' done' : ''));
        marker.appendChild(dia);

        // Tick below line
        const tick2 = mk('div', 'ms-tick');
        marker.appendChild(tick2);

        // Box label on bottom half
        const box = mk('div', 'ms-box' + (isDone ? ' done' : ''));
        box.style.marginBottom = '8px';
        box.textContent = sn;
        marker.appendChild(box);
      }

      // Tooltip
      marker.addEventListener('mouseenter', e => showTT(e, m));
      marker.addEventListener('mousemove',  e => moveTT(e));
      marker.addEventListener('mouseleave', hideTT);

      tl.appendChild(marker);
    });

    row.appendChild(tl);
    group.appendChild(row);
    root.appendChild(group);
  });
}

function isLaunch(name) {
  if (!name) return false;
  const n = name.toLowerCase();
  return n.includes('retailer') || n.includes('launch');
}

// ── TOOLTIP ───────────────────────────────────────────
const tooltip = document.getElementById('tt');
function showTT(e, m) {
  document.getElementById('tt-name').textContent  = m.name;
  const s = fmtDate(m.startDate), end = fmtDate(m.endDate);
  document.getElementById('tt-date').textContent  = (end && end !== s) ? `${s} → ${end}` : s;
  document.getElementById('tt-phase').textContent = m.phase + (m.status ? ' · ' + m.status : '');
  moveTT(e); tooltip.classList.add('on');
}
function moveTT(e) {
  const tw = tooltip.offsetWidth || 220, th = tooltip.offsetHeight || 90;
  tooltip.style.left = (e.clientX+14+tw > window.innerWidth  ? e.clientX-tw-14 : e.clientX+14) + 'px';
  tooltip.style.top  = (e.clientY-10+th > window.innerHeight ? e.clientY-th    : e.clientY-10) + 'px';
}
function hideTT() { tooltip.classList.remove('on'); }

// ── UTILS ──────────────────────────────────────────────
function mk(tag, cls) { const e = document.createElement(tag); if (cls) e.className = cls; return e; }
function groupBy(arr, key) {
  return arr.reduce((a, i) => { const k = i[key]||'Other'; if(!a[k]) a[k]=[]; a[k].push(i); return a; }, {});
}
function bestDate(...cands) {
  for (const d of cands) { if (!d) continue; const ts = Date.parse(d); if (!isNaN(ts)) return ts; }
  return null;
}
function fmtDate(ts) {
  if (!ts) return '—';
  return new Date(ts).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}
function fmtDateShort(ts) {
  if (!ts) return '—';
  return new Date(ts).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}
function setMsg(t) { const m = document.getElementById('msg'); m.style.display = ''; m.textContent = t; }
</script>
</body>
</html>
