<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>2026 Campaign Calendar</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Mono:wght@400;500&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg:              #0d0f14;
    --surface:         #161922;
    --surface2:        #1c2030;
    --border:          #252a35;
    --text:            #e8eaf0;
    --muted:           #5a6070;
    --accent:          #f0c040;
    --phase-planning:  #4a9eff;
    --phase-execution: #b36fff;
    --phase-launch:    #40d9a0;
    --phase-review:    #ff7c5c;
    --phase-done:      #3a4050;
    --font-mono:       'DM Mono', monospace;
    --font-display:    'DM Serif Display', serif;
    --font-ui:         'Syne', sans-serif;
    --dot-r:           7px;
    --row-h:           48px;
  }
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: var(--bg); color: var(--text); font-family: var(--font-ui); min-height: 100vh; }

  /* MODAL */
  #modal-overlay {
    position: fixed; inset: 0; z-index: 999;
    background: rgba(0,0,0,.88); backdrop-filter: blur(10px);
    display: flex; align-items: center; justify-content: center;
  }
  #modal-overlay.hidden { display: none; }
  .modal-box {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 18px; padding: 48px; width: min(500px, 92vw);
    position: relative; box-shadow: 0 48px 140px rgba(0,0,0,.7);
  }
  .modal-box::after {
    content: ''; position: absolute; top: 0; left: 48px; right: 48px; height: 1px;
    background: linear-gradient(90deg, transparent, var(--accent), transparent);
  }
  .modal-eyebrow { font-family: var(--font-mono); font-size: 10px; letter-spacing: .14em; color: var(--accent); text-transform: uppercase; margin-bottom: 14px; }
  .modal-title   { font-family: var(--font-display); font-size: 30px; line-height: 1.2; margin-bottom: 10px; }
  .modal-sub     { font-size: 13px; color: var(--muted); line-height: 1.6; margin-bottom: 30px; }
  .modal-input {
    width: 100%; background: var(--bg); border: 1px solid var(--border);
    border-radius: 8px; padding: 13px 16px; color: var(--text);
    font-family: var(--font-mono); font-size: 13px; outline: none;
    transition: border-color .2s; margin-bottom: 14px;
  }
  .modal-input:focus { border-color: var(--accent); }
  .modal-input::placeholder { color: var(--muted); }
  .modal-btn {
    width: 100%; background: var(--accent); color: #000; border: none;
    border-radius: 8px; padding: 14px; font-family: var(--font-ui);
    font-weight: 700; font-size: 14px; letter-spacing: .04em;
    cursor: pointer; transition: opacity .15s, transform .1s;
  }
  .modal-btn:hover { opacity: .85; }
  .modal-btn:active { transform: scale(.98); }
  .modal-btn:disabled { opacity: .4; cursor: default; }
  .modal-err { font-size: 12px; color: var(--phase-review); margin-top: 10px; min-height: 16px; font-family: var(--font-mono); }

  /* HEADER */
  header { padding: 32px 48px 20px; display: flex; align-items: flex-end; justify-content: space-between; border-bottom: 1px solid var(--border); gap: 24px; flex-wrap: wrap; }
  .h-title { font-family: var(--font-display); font-size: 34px; letter-spacing: -.02em; line-height: 1; }
  .h-title em { color: var(--accent); }
  .h-sub { margin-top: 6px; font-family: var(--font-mono); font-size: 11px; color: var(--muted); letter-spacing: .06em; }
  .h-legend { display: flex; gap: 18px; flex-wrap: wrap; align-items: center; }
  .leg { display: flex; align-items: center; gap: 7px; font-family: var(--font-mono); font-size: 11px; color: var(--muted); }
  .leg-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }

  /* CONTROLS */
  .controls { padding: 14px 48px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center; border-bottom: 1px solid var(--border); }
  .ctl-label { font-family: var(--font-mono); font-size: 10px; color: var(--muted); letter-spacing: .1em; text-transform: uppercase; margin-right: 2px; }
  .filter-btn { background: transparent; border: 1px solid var(--border); border-radius: 6px; color: var(--muted); font-family: var(--font-mono); font-size: 11px; padding: 5px 12px; cursor: pointer; transition: all .15s; letter-spacing: .03em; }
  .filter-btn:hover  { border-color: var(--accent); color: var(--text); }
  .filter-btn.active { border-color: var(--accent); color: var(--accent); background: rgba(240,192,64,.07); }
  .spacer { flex: 1; }
  #refresh-btn { display: flex; align-items: center; gap: 7px; background: transparent; border: 1px solid var(--border); border-radius: 6px; color: var(--muted); font-family: var(--font-mono); font-size: 11px; padding: 5px 12px; cursor: pointer; transition: all .15s; }
  #refresh-btn:hover { border-color: var(--text); color: var(--text); }
  #status-dot { width: 7px; height: 7px; border-radius: 50%; background: var(--muted); transition: background .3s; flex-shrink: 0; }
  #status-dot.live    { background: var(--phase-launch); box-shadow: 0 0 6px var(--phase-launch); }
  #status-dot.loading { background: var(--accent); animation: blink 1s infinite; }
  #status-dot.error   { background: var(--phase-review); }
  @keyframes blink { 0%,100%{opacity:1} 50%{opacity:.25} }

  /* MAIN */
  main { padding: 0 0 100px; opacity: 0; transition: opacity .4s; }
  main.visible { opacity: 1; }
  #msg { padding: 80px 48px; text-align: center; font-family: var(--font-mono); font-size: 13px; color: var(--muted); letter-spacing: .05em; }
  .scroll-wrapper { overflow-x: auto; }
  .timeline-root  { min-width: 880px; }

  /* Month header */
  .month-header { position: sticky; top: 0; z-index: 10; background: var(--bg); border-bottom: 1px solid var(--border); display: flex; height: 34px; }
  .mh-spacer { flex-shrink: 0; width: 200px; border-right: 1px solid var(--border); }
  .mh-track  { flex: 1; position: relative; overflow: hidden; }
  .mh-cell { position: absolute; top: 0; bottom: 0; display: flex; align-items: center; padding-left: 10px; font-family: var(--font-mono); font-size: 10px; color: var(--muted); letter-spacing: .07em; text-transform: uppercase; border-left: 1px solid var(--border); white-space: nowrap; }

  /* Campaign rows */
  .camp-group { border-bottom: 1px solid var(--border); }
  .camp-row   { display: flex; align-items: stretch; }
  .camp-lbl { flex-shrink: 0; width: 200px; padding: 12px 18px; border-right: 1px solid var(--border); display: flex; flex-direction: column; justify-content: center; gap: 4px; }
  .camp-name { font-size: 13px; font-weight: 700; line-height: 1.25; }
  .camp-meta { font-family: var(--font-mono); font-size: 10px; color: var(--muted); }
  .camp-tl   { flex: 1; position: relative; }

  /* Phase lanes */
  .phase-lane { position: relative; min-height: var(--row-h); border-bottom: 1px solid rgba(255,255,255,.025); }
  .phase-lane:last-child { border-bottom: none; }

  /* Grid lines */
  .grid-line  { position: absolute; top: 0; bottom: 0; width: 1px; background: var(--border); pointer-events: none; }
  .today-line { position: absolute; top: 0; bottom: 0; width: 2px; background: var(--accent); opacity: .4; pointer-events: none; z-index: 2; }
  .today-lbl  { position: absolute; top: 3px; transform: translateX(-50%); font-family: var(--font-mono); font-size: 9px; color: var(--accent); letter-spacing: .07em; white-space: nowrap; pointer-events: none; z-index: 2; }

  /* Milestone bar */
  .ms-bar { position: absolute; top: 50%; transform: translateY(-50%); height: 5px; border-radius: 3px; opacity: .22; pointer-events: none; }

  /* Milestone dot */
  .ms-dot { position: absolute; top: 50%; transform: translate(-50%, -50%); width: calc(var(--dot-r) * 2); height: calc(var(--dot-r) * 2); border-radius: 50%; cursor: pointer; border: 2px solid var(--bg); transition: transform .14s, box-shadow .14s; z-index: 3; }
  .ms-dot:hover { transform: translate(-50%, -50%) scale(1.55); z-index: 20; }
  .ms-dot.done  { opacity: .35; }

  /* Tooltip */
  .tt { position: fixed; z-index: 200; pointer-events: none; opacity: 0; transition: opacity .12s; background: var(--surface2); border: 1px solid var(--border); border-radius: 10px; padding: 12px 16px; max-width: 280px; box-shadow: 0 20px 60px rgba(0,0,0,.7); }
  .tt.on { opacity: 1; }
  .tt-phase { font-family: var(--font-mono); font-size: 10px; letter-spacing: .08em; text-transform: uppercase; margin-bottom: 4px; }
  .tt-name  { font-size: 13px; font-weight: 700; line-height: 1.35; margin-bottom: 6px; }
  .tt-dates { font-family: var(--font-mono); font-size: 11px; color: var(--muted); margin-bottom: 5px; }
  .tt-row   { display: flex; align-items: center; gap: 5px; font-family: var(--font-mono); font-size: 10px; }
  .tt-row .dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }

  @media (max-width: 700px) {
    header, .controls { padding-left: 16px; padding-right: 16px; }
    .camp-lbl { width: 130px; }
    .mh-spacer { width: 130px; }
  }
</style>
</head>
<body>

<div id="modal-overlay">
  <div class="modal-box">
    <div class="modal-eyebrow">2026 · Live Campaign Calendar</div>
    <h2 class="modal-title">Enter your<br><em>Airtable token</em></h2>
    <p class="modal-sub">Stored only in this browser session — never sent anywhere except directly to the Airtable API.</p>
    <input class="modal-input" id="token-input" type="password" placeholder="pat2Cx…" autocomplete="off" spellcheck="false">
    <button class="modal-btn" id="connect-btn">Connect to Airtable →</button>
    <div class="modal-err" id="modal-err"></div>
  </div>
</div>

<div class="tt" id="tt">
  <div class="tt-phase" id="tt-phase"></div>
  <div class="tt-name"  id="tt-name"></div>
  <div class="tt-dates" id="tt-dates"></div>
  <div class="tt-row"   id="tt-status"></div>
</div>

<header>
  <div>
    <div class="h-title">2026 <em>Campaign</em> Calendar</div>
    <div class="h-sub" id="h-sub">— connecting —</div>
  </div>
  <div class="h-legend">
    <div class="leg"><span class="leg-dot" style="background:var(--phase-planning)"></span> Planning</div>
    <div class="leg"><span class="leg-dot" style="background:var(--phase-execution)"></span> Execution</div>
    <div class="leg"><span class="leg-dot" style="background:var(--phase-launch)"></span> Launch</div>
    <div class="leg"><span class="leg-dot" style="background:var(--phase-review)"></span> Review &amp; Report</div>
    <div class="leg"><span class="leg-dot" style="background:var(--phase-done);opacity:.5"></span> Done</div>
  </div>
</header>

<div class="controls">
  <span class="ctl-label">Phase</span>
  <button class="filter-btn active" data-filter="all">All</button>
  <button class="filter-btn" data-filter="Planning">Planning</button>
  <button class="filter-btn" data-filter="Execution">Execution</button>
  <button class="filter-btn" data-filter="Launch">Launch</button>
  <button class="filter-btn" data-filter="Review & Report">Review &amp; Report</button>
  <div class="spacer"></div>
  <button id="refresh-btn"><span id="status-dot"></span> Refresh</button>
</div>

<main id="main">
  <div id="msg">Connecting to Airtable…</div>
  <div class="scroll-wrapper" id="scroll-wrapper" style="display:none">
    <div class="timeline-root" id="timeline-root"></div>
  </div>
</main>

<script>
const BASE_ID        = 'appeiBEuOf8zRHX96';
const MILESTONES_TBL = '[MASTER] Milestones';
const CAMPAIGNS_TBL  = 'Campaigns';

const PHASE_COLOR = {
  'Planning':        'var(--phase-planning)',
  'Execution':       'var(--phase-execution)',
  'Launch':          'var(--phase-launch)',
  'Review & Report': 'var(--phase-review)',
};
const PHASE_ORDER = ['Planning','Execution','Launch','Review & Report'];
const phaseColor = p => PHASE_COLOR[p] || 'var(--muted)';

let TOKEN = '', milestones = [], campaignMap = {}, activeFilter = 'all';

// ── MODAL ────────────────────────────────────────
const overlay    = document.getElementById('modal-overlay');
const tokenInput = document.getElementById('token-input');
const connectBtn = document.getElementById('connect-btn');
const modalErr   = document.getElementById('modal-err');

const saved = sessionStorage.getItem('at_tok_2026');
if (saved) { TOKEN = saved; overlay.classList.add('hidden'); init(); }

connectBtn.addEventListener('click', async () => {
  const t = tokenInput.value.trim();
  if (!t) { modalErr.textContent = 'Please paste your Airtable personal access token.'; return; }
  connectBtn.disabled = true;
  connectBtn.textContent = 'Connecting…';
  modalErr.textContent = '';
  const ok = await testToken(t);
  if (ok) {
    TOKEN = t;
    sessionStorage.setItem('at_tok_2026', t);
    overlay.classList.add('hidden');
    init();
  } else {
    modalErr.textContent = 'Connection failed. Check your token and try again.';
    connectBtn.disabled = false;
    connectBtn.textContent = 'Connect to Airtable →';
  }
});
tokenInput.addEventListener('keydown', e => { if (e.key === 'Enter') connectBtn.click(); });

async function testToken(t) {
  try {
    const r = await fetch(
      `https://api.airtable.com/v0/${BASE_ID}/${enc(MILESTONES_TBL)}?maxRecords=1`,
      { headers: { Authorization: `Bearer ${t}` } }
    );
    return r.ok;
  } catch { return false; }
}

// ── FETCH ────────────────────────────────────────
async function fetchTable(tbl) {
  const recs = [];
  let offset = null;
  do {
    let url = `https://api.airtable.com/v0/${BASE_ID}/${enc(tbl)}?pageSize=100`;
    if (offset) url += `&offset=${offset}`;
    const r = await fetch(url, { headers: { Authorization: `Bearer ${TOKEN}` } });
    if (!r.ok) throw new Error(`Airtable ${r.status} on "${tbl}"`);
    const d = await r.json();
    recs.push(...d.records);
    offset = d.offset || null;
  } while (offset);
  return recs;
}

const setStatus = s => { document.getElementById('status-dot').className = s; };
const enc = s => encodeURIComponent(s);

// ── INIT ─────────────────────────────────────────
async function init() {
  setStatus('loading');
  setMsg('Fetching campaigns…');

  try {
    // Step 1: Build Campaign record ID → name map
    campaignMap = {};
    try {
      const campRecs = await fetchTable(CAMPAIGNS_TBL);
      campRecs.forEach(rec => {
        const f = rec.fields;
        // Try common primary field names
        const name = f['Name'] || f['Campaign Name'] || f['Campaign'] || f['Title'] || Object.values(f)[0] || rec.id;
        campaignMap[rec.id] = String(name);
      });
      console.log(`Loaded ${Object.keys(campaignMap).length} campaigns:`, campaignMap);
    } catch(e) {
      console.warn('Could not load Campaigns table:', e.message,
        '— will use raw IDs as campaign names');
    }

    // Step 2: Fetch all milestones
    setMsg('Fetching milestones…');
    const rawRecs = await fetchTable(MILESTONES_TBL);
    console.log('Sample record fields:', rawRecs[0]?.fields);

    // Step 3: Normalise
    milestones = rawRecs.map(rec => {
      const f = rec.fields;

      // Campaign: linked record field → array of record IDs
      let campName = 'Uncategorized';
      const cf = f['Campaign'];
      if (Array.isArray(cf) && cf.length > 0) {
        campName = campaignMap[cf[0]] || cf[0];
      } else if (typeof cf === 'string' && cf) {
        campName = campaignMap[cf] || cf;
      }

      return {
        id:        rec.id,
        name:      f['Milestones'] || f['Name'] || '(unnamed)',
        campaign:  campName,
        phase:     f['Phase']     || 'Other',
        status:    f['Status']    || '',
        channel:   f['Channel']   || '',
        duration:  f['Duration (Days)'] || null,
        startDate: bestDate(f['Auto Start Date'], f['Start Date']),
        endDate:   bestDate(f['Auto End Date'],   f['Start Date']),
        sortOrder: f['Sort Order'] || 999,
      };
    });

    setStatus('live');
    const camps = new Set(milestones.map(m => m.campaign));
    document.getElementById('h-sub').textContent =
      `${milestones.length} milestones · ${camps.size} campaigns · live`;

    render();
    document.getElementById('main').classList.add('visible');

  } catch(e) {
    setStatus('error');
    setMsg('⚠ ' + e.message);
    console.error(e);
  }
}

document.getElementById('refresh-btn').addEventListener('click', () => { if (TOKEN) init(); });

// ── FILTER ───────────────────────────────────────
document.querySelectorAll('.filter-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    activeFilter = btn.dataset.filter;
    render();
  });
});

// ── RENDER ───────────────────────────────────────
function render() {
  const data = activeFilter === 'all' ? milestones : milestones.filter(m => m.phase === activeFilter);
  const bycamp = groupBy(data, 'campaign');
  const campNames = Object.keys(bycamp).sort();

  if (!campNames.length) {
    setMsg('No records match this filter.');
    document.getElementById('scroll-wrapper').style.display = 'none';
    return;
  }
  document.getElementById('msg').style.display = 'none';
  document.getElementById('scroll-wrapper').style.display = '';

  // Date range
  let minTs = Infinity, maxTs = -Infinity;
  data.forEach(m => {
    if (m.startDate) { if (m.startDate < minTs) minTs = m.startDate; if (m.startDate > maxTs) maxTs = m.startDate; }
    if (m.endDate)   { if (m.endDate   > maxTs) maxTs = m.endDate; }
  });

  const minD = new Date(minTs); minD.setDate(1);
  const maxD = new Date(maxTs); maxD.setDate(1); maxD.setMonth(maxD.getMonth() + 2);
  const rMin = minD.getTime(), rMax = maxD.getTime(), span = rMax - rMin;
  const pct = ts => ((ts - rMin) / span * 100).toFixed(4) + '%';

  const months = [];
  const mc = new Date(rMin);
  while (mc.getTime() < rMax) { months.push(new Date(mc)); mc.setMonth(mc.getMonth() + 1); }

  const root = document.getElementById('timeline-root');
  root.innerHTML = '';

  // Month header
  const mhdr = mk('div', 'month-header');
  mhdr.appendChild(mk('div', 'mh-spacer'));
  const mtrack = mk('div', 'mh-track');
  months.forEach(m => {
    const c = mk('div', 'mh-cell');
    c.style.left = pct(m.getTime());
    c.textContent = m.toLocaleString('default', { month: 'short' }) + ' \'' + String(m.getFullYear()).slice(2);
    mtrack.appendChild(c);
  });
  mhdr.appendChild(mtrack);
  root.appendChild(mhdr);

  const today = Date.now();

  // Campaign rows
  campNames.forEach(campName => {
    const cms = bycamp[campName];
    const done = cms.filter(m => m.status === 'Done').length;
    const byPhase = groupBy(cms, 'phase');
    const phases = [...PHASE_ORDER.filter(p => byPhase[p]), ...Object.keys(byPhase).filter(p => !PHASE_ORDER.includes(p))];

    const group = mk('div', 'camp-group');
    const row   = mk('div', 'camp-row');
    const lbl   = mk('div', 'camp-lbl');
    const nm    = mk('div', 'camp-name'); nm.textContent = campName;
    const mt    = mk('div', 'camp-meta'); mt.textContent = `${done}/${cms.length} complete`;
    lbl.append(nm, mt);
    row.appendChild(lbl);

    const tl = mk('div', 'camp-tl');

    phases.forEach((phase, pi) => {
      const lane = mk('div', 'phase-lane');

      months.forEach(m => {
        const gl = mk('div', 'grid-line'); gl.style.left = pct(m.getTime()); lane.appendChild(gl);
      });

      if (pi === 0 && today >= rMin && today <= rMax) {
        const tll = mk('div', 'today-line'); tll.style.left = pct(today); lane.appendChild(tll);
        const tlb = mk('div', 'today-lbl'); tlb.style.left = pct(today); tlb.textContent = 'TODAY'; lane.appendChild(tlb);
      }

      byPhase[phase].forEach(m => {
        if (!m.startDate) return;
        const color = m.status === 'Done' ? 'var(--phase-done)' : phaseColor(phase);

        if (m.endDate && m.endDate > m.startDate) {
          const bar = mk('div', 'ms-bar');
          bar.style.left = pct(m.startDate);
          bar.style.width = pct(m.endDate - m.startDate);
          bar.style.background = color;
          lane.appendChild(bar);
        }

        const dot = mk('div', 'ms-dot' + (m.status === 'Done' ? ' done' : ''));
        dot.style.left = pct(m.startDate);
        dot.style.background = color;
        if (m.status !== 'Done') dot.style.boxShadow = `0 0 8px ${color}50`;
        dot.addEventListener('mouseenter', e => showTT(e, m, phase, color));
        dot.addEventListener('mousemove',  e => moveTT(e));
        dot.addEventListener('mouseleave', hideTT);
        lane.appendChild(dot);
      });

      tl.appendChild(lane);
    });

    row.appendChild(tl);
    group.appendChild(row);
    root.appendChild(group);
  });
}

// ── TOOLTIP ──────────────────────────────────────
const tooltip = document.getElementById('tt');
function showTT(e, m, phase, color) {
  document.getElementById('tt-phase').textContent = phase;
  document.getElementById('tt-phase').style.color = color;
  document.getElementById('tt-name').textContent  = m.name;
  const s = fmtDate(m.startDate), end = fmtDate(m.endDate);
  document.getElementById('tt-dates').textContent =
    (end && end !== s) ? `${s} → ${end}${m.duration ? '  ('+m.duration+' days)' : ''}` : (s || '—');
  const st = document.getElementById('tt-status');
  st.innerHTML = `<span class="dot" style="background:${color}"></span>${m.status||'—'}${m.channel?' · '+m.channel:''}`;
  moveTT(e); tooltip.classList.add('on');
}
function moveTT(e) {
  const tw = tooltip.offsetWidth || 250, th = tooltip.offsetHeight || 110;
  tooltip.style.left = (e.clientX+14+tw > window.innerWidth  ? e.clientX-tw-14 : e.clientX+14) + 'px';
  tooltip.style.top  = (e.clientY-10+th > window.innerHeight ? e.clientY-th    : e.clientY-10) + 'px';
}
function hideTT() { tooltip.classList.remove('on'); }

// ── UTILS ─────────────────────────────────────────
function mk(tag, cls) { const e = document.createElement(tag); if (cls) e.className = cls; return e; }
function groupBy(arr, key) {
  return arr.reduce((acc, item) => {
    const k = item[key] || 'Other';
    if (!acc[k]) acc[k] = [];
    acc[k].push(item);
    return acc;
  }, {});
}
function bestDate(...candidates) {
  for (const d of candidates) {
    if (!d) continue;
    const ts = Date.parse(d);
    if (!isNaN(ts)) return ts;
  }
  return null;
}
function fmtDate(ts) {
  if (!ts) return null;
  return new Date(ts).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}
function setMsg(t) {
  const m = document.getElementById('msg');
  m.style.display = ''; m.textContent = t;
}
</script>
</body>
</html>
